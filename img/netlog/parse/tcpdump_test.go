package parse

import (
	"fmt"
	"testing"

	"github.com/stretchr/testify/require"
)

const (
	exampleDump = `        0x0000:  0000 0001 0006 0242 0a01 0051 0000 0800  .......B...Q....
        0x0010:  4500 0028 7997 4000 4006 ac89 0a01 0051  E..(y.@.@......Q
        0x0020:  0a01 005d dd62 1388 51c4 a98b 0000 0000  ...].b..Q.......
        0x0030:  5004 0000 aef6 0000                      P.......
`
	exampleDumpMisaligned = `        0x0000:  0004 0001 0006 0242 ac12 0004 0000 0800  .......B........
        0x0010:  4500 0045 50a7 4000 4011 91c9 ac12 0004  E..EP.@.@.......
        0x0020:  ac1f 0002 98a0 0035 0031 587a 1c08 0100  .......5.1Xz....
        0x0030:  0001 0000 0000 0000 0131 0130 0231 3803  .........1.0.18.
        0x0040:  3137 3207 696e 2d61 6464 7204 6172 7061  172.in-addr.arpa
        0x0050:  0000 0c00 01                             .....
`
)

var (
	exampleDumpAsHex           = []byte{0x00, 0x00, 0x00, 0x01, 0x00, 0x06, 0x02, 0x42, 0x0a, 0x01, 0x00, 0x51, 0x00, 0x00, 0x08, 0x00, 0x45, 0x00, 0x00, 0x28, 0x79, 0x97, 0x40, 0x00, 0x40, 0x06, 0xac, 0x89, 0x0a, 0x01, 0x00, 0x51, 0x0a, 0x01, 0x00, 0x5d, 0xdd, 0x62, 0x13, 0x88, 0x51, 0xc4, 0xa9, 0x8b, 0x00, 0x00, 0x00, 0x00, 0x50, 0x04, 0x00, 0x00, 0xae, 0xf6, 0x00, 0x00}
	exampleDumpMisalignedAsHex = []byte{0x00, 0x04, 0x00, 0x01, 0x00, 0x06, 0x02, 0x42, 0xac, 0x12, 0x00, 0x04, 0x00, 0x00, 0x08, 0x00, 0x45, 0x00, 0x00, 0x45, 0x50, 0xa7, 0x40, 0x00, 0x40, 0x11, 0x91, 0xc9, 0xac, 0x12, 0x00, 0x04, 0xac, 0x1f, 0x00, 0x02, 0x98, 0xa0, 0x00, 0x35, 0x00, 0x31, 0x58, 0x7a, 0x1c, 0x08, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x31, 0x01, 0x30, 0x02, 0x31, 0x38, 0x03, 0x31, 0x37, 0x32, 0x07, 0x69, 0x6e, 0x2d, 0x61, 0x64, 0x64, 0x72, 0x04, 0x61, 0x72, 0x70, 0x61, 0x00, 0x00, 0x0c, 0x00, 0x01}
)

func TestParseTCPDumpHexDump(t *testing.T) {
	cases := []struct {
		name     string
		dump     string
		expected []byte
	}{
		{
			name:     "aligned",
			dump:     exampleDump,
			expected: exampleDumpAsHex,
		},
		{
			name:     "misaligned",
			dump:     exampleDumpMisaligned,
			expected: exampleDumpMisalignedAsHex,
		},
	}
	for i, tc := range cases {
		t.Run(fmt.Sprintf("%d-%s", i, tc.name), func(t *testing.T) {
			actual, err := ParseTCPDumpHexDump([]byte(tc.dump))
			require.NoError(t, err)
			require.Equal(t, tc.expected, actual)
		})
	}
}
